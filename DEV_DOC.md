# Clade å¼€å‘æ–‡æ¡£

æœ¬æ–‡æ¡£é¢å‘å¼€å‘è€…ï¼Œæ—¨åœ¨æ·±å…¥è§£æ **æ··åˆæ¼”åŒ–æ¶æ„ (Hybrid Evolutionary Architecture)** çš„å®ç°åŸç†ã€‚å¦‚æœä½ æƒ³äº†è§£ç³»ç»Ÿæ˜¯å¦‚ä½•åœ¨â€œæ­»æ¿çš„è§„åˆ™â€å’Œâ€œçµæ´»çš„ AIâ€ä¹‹é—´å–å¾—å¹³è¡¡çš„ï¼Œè¯·é˜…è¯»æœ¬æ–‡ã€‚

## 1. æ ¸å¿ƒæ¶æ„ï¼šæ··åˆå¼•æ“ (The Hybrid Engine)

ç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯ `SimulationEngine` (`backend/app/simulation/engine.py`)ï¼Œå®ƒåƒä¸€ä¸ªç²¾å¯†çš„é½¿è½®ç»„ï¼Œå°†è§„åˆ™è®¡ç®—ä¸ AI æ¨ç†å’¬åˆåœ¨ä¸€èµ·ã€‚

### 1.1 æ¼”åŒ–å¾ªç¯ (The Loop)
æ¯ä¸ªå›åˆï¼ˆTurnï¼‰ä»£è¡¨åœ°è´¨æ—¶é—´å°ºåº¦ä¸Šçš„çº¦ 50 ä¸‡å¹´ã€‚å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š

1.  **ç¯å¢ƒè¾“å…¥ (Rules)**ï¼šè§£ææ¸©åº¦ã€æ¹¿åº¦ã€æµ·å¹³é¢å˜åŒ–ã€‚
2.  **åœ°å½¢æ¼”åŒ– (Rules)**ï¼š
    *   **Rules**: `MapEvolutionService` ç®¡ç†æ¿å—è¿åŠ¨é˜¶æ®µï¼ˆç¨³å®š/åˆ†è£‚/ç¢°æ’ï¼‰ä¸å…¨çƒæ°”å€™å‚æ•°ï¼Œå¹¶è´Ÿè´£æµ·å¹³é¢/æ°”å€™çš„é€å›åˆæ¨è¿›ã€‚
    *   **Legacy**: æ—§ç‰ˆ `TerrainEvolutionService`ï¼ˆAI åœ°å½¢äº‹ä»¶ï¼‰å·²é€€å½¹ï¼Œç°é˜¶æ®µä»…ä½¿ç”¨è§„åˆ™å±‚é€»è¾‘ä»¥é™ä½å¤æ‚åº¦ã€‚
3.  **è¥å…»çº§äº’åŠ¨ (Rules)**ï¼š
    *   è®¡ç®—å…¨å›¾ç”Ÿç‰©é‡ï¼ˆBiomassï¼‰ã€‚
    *   è‡ªä¸‹è€Œä¸Šï¼ˆBottom-upï¼‰è®¡ç®—èµ„æºé™åˆ¶ï¼šæ¤ç‰© -> é£Ÿè‰ -> é£Ÿè‚‰ã€‚
    *   è‡ªä¸Šè€Œä¸‹ï¼ˆTop-downï¼‰è®¡ç®—æ•é£Ÿå‹åŠ›ã€‚
4.  **æ­»äº¡åˆ¤å®š (Rules)**ï¼šåŸºäºé€‚åº”æ€§ã€ç«äº‰å‹åŠ›ã€å¯¿å‘½æé™è®¡ç®—æ­»äº¡ç‡ã€‚
5.  **AI å™äº‹ (AI)**ï¼š`ReportBuilder` å°†æ¯ç‡¥çš„æ­»äº¡æ•°æ®è½¬åŒ–ä¸ºâ€œç‰©ç§å…´è¡°å²â€ã€‚
6.  **ç¹æ®–ä¸å˜å¼‚ (Hybrid)**ï¼š
    *   **Rules**: å†³å®šç”Ÿå¤šå°‘ï¼ˆr/K ç­–ç•¥ï¼‰ã€‚
    *   **AI**: å†³å®šé•¿æˆä»€ä¹ˆæ ·ï¼ˆåˆ†åŒ–ã€æ–°å™¨å®˜ã€æ–°ç‰¹æ€§ï¼‰ã€‚

### 1.2 å…³é”®ç®—æ³•æœåŠ¡

#### ğŸ›¡ï¸ è§„åˆ™å±‚ (The Shield)
è¿™äº›æœåŠ¡ä¿è¯äº†ç³»ç»Ÿä¸ä¼šâ€œæ•°å€¼å´©åâ€ï¼š

*   **`TrophicLevelCalculator` (è¥å…»çº§è®¡ç®—)**ï¼š
    *   è‡ªåŠ¨åˆ†æç‰©ç§æè¿°ï¼Œåˆ†é… T1.0 (ç”Ÿäº§è€…) åˆ° T5.0+ (é¡¶çº§æ é£Ÿè€…)ã€‚
    *   **ç¡¬çº¦æŸ**ï¼šé«˜è¥å…»çº§ç‰©ç§å¿…é¡»æœ‰æ›´ä½çš„ç§ç¾¤æ•°é‡ä¸Šé™ï¼ˆèƒ½é‡é‡‘å­—å¡”ï¼‰ã€‚
*   **`MortalityEngine` (æ­»äº¡å¼•æ“)**ï¼š
    *   ç»¼åˆè€ƒè™‘ 5 ç§å‹åŠ›ï¼šç¯å¢ƒä¸é€‚ã€ç”Ÿæ€ä½é‡å ã€èµ„æºåŒ®ä¹ã€è¢«æ•é£Ÿã€è‡ªç„¶è¡°è€ã€‚
    *   å¼•å…¥ **æœ€å°ç”Ÿå­˜é˜ˆå€¼**ï¼Œé˜²æ­¢ç§ç¾¤æ— é™è¶‹è¿‘äºé›¶è€Œä¸ç­ç»ã€‚
*   **`GeneticDistanceCalculator` (é—ä¼ è·ç¦»)**ï¼š
    *   åŸºäºå½¢æ€ä¸åŸºå› ç‰¹å¾è®¡ç®— 0.0-1.0 çš„è·ç¦»ã€‚
    *   **ç¡¬çº¦æŸ**ï¼šè·ç¦» > 0.5 çš„ç‰©ç§ç»å¯¹æ— æ³•æ‚äº¤ã€‚
*   **`SpeciesTieringService` (ç‰©ç§åˆ†çº§)**ï¼š
    *   **æ€§èƒ½ä¼˜åŒ–**ï¼šå°†ç‰©ç§åˆ†ä¸º `Critical` (ç„¦ç‚¹)ã€`Normal` (æ™®é€š) å’Œ `Background` (èƒŒæ™¯)ã€‚
    *   **èƒŒæ™¯ç‰©ç§**ï¼šæ•°é‡åºå¤§ä½†å…³æ³¨åº¦ä½çš„ç‰©ç§ä»…è¿›è¡Œæ•°å€¼æ¨¡æ‹Ÿï¼Œä¸æ¶ˆè€— AI Tokenã€‚

#### ğŸ¨ åˆ›æ„å±‚ (The Brush)
è¿™äº›æœåŠ¡è´Ÿè´£æä¾›æ— é™çš„å¯èƒ½æ€§ï¼š

*   **`SpeciationService` (åˆ†åŒ–æœåŠ¡)**ï¼š
    *   å½“ç¯å¢ƒå‹åŠ›è¿‡å¤§æˆ–ç”Ÿæ€ä½ç©ºç¼ºæ—¶è§¦å‘ã€‚
    *   AI æ¥æ”¶çˆ¶ä»£ç‰¹å¾ + ç¯å¢ƒå‹åŠ›ï¼Œç”Ÿæˆå…¨æ–°çš„å­ä»£ç‰©ç§ï¼ˆåŒ…æ‹¬æ‹‰ä¸åã€å½¢æ€æè¿°ã€æ–°å™¨å®˜ï¼‰ã€‚
*   **`NicheAnalyzer` (ç”Ÿæ€ä½åˆ†æ)**ï¼š
    *   ä½¿ç”¨ Embedding å‘é‡åŒ–ç‰©ç§æè¿°ã€‚
    *   è®¡ç®—ç‰©ç§é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œåˆ¤æ–­å®ƒä»¬æ˜¯åœ¨â€œæ¿€çƒˆç«äº‰â€è¿˜æ˜¯â€œäº’åˆ©å…±ç”Ÿâ€ã€‚
*   **`TerrainEvolutionService` (åœ°å½¢æ¼”åŒ–)**ï¼š**å·²é€€å½¹**ï¼Œç›¸å…³ä»£ç å·²ç§»é™¤ï¼Œå¾…æœªæ¥æœ‰æ–°çš„ç‰©ç†é©±åŠ¨æ–¹æ¡ˆå†æ¢å¤ã€‚

#### ğŸ§¬ é€‚åº”å±‚ (The Adapter)
è¿™äº›æœåŠ¡è´Ÿè´£ç‰©ç§åœ¨ä¸ªä½“ç³»å†…çš„åŠ¨æ€è°ƒæ•´ä¸èµ„æºåˆ†é…ï¼š

*   **`GeneActivationService` (åŸºå› æ¿€æ´»)**ï¼š
    *   **è¡¨è§‚é—ä¼ æœºåˆ¶**ï¼šå½“ç‰©ç§é¢ä¸´æé«˜æ­»äº¡ç‡ï¼ˆ>50%ï¼‰æ—¶ï¼Œæ²‰ç¡çš„â€œä¼‘çœ åŸºå› â€ä¼šè¢«å”¤é†’ã€‚
    *   **å‹åŠ›ç‰¹å¼‚æ€§**ï¼šå¹²æ—±å‹åŠ›æ¿€æ´»è€æ—±åŸºå› ï¼Œå¯’å†·å‹åŠ›æ¿€æ´»çš®æ¯›åŸºå› ã€‚
*   **`FocusBatchProcessor` (ç„¦ç‚¹å™äº‹)**ï¼š
    *   **ç®—åŠ›åˆ†é…**ï¼šç³»ç»Ÿä¸ä¼šå¯¹æ‰€æœ‰ 100+ ä¸ªç‰©ç§éƒ½è¿›è¡Œè¯¦å°½çš„ AI å™äº‹ã€‚
    *   **æ™ºèƒ½èšç„¦**ï¼šåªå¯¹â€œä¸»è§’â€ï¼ˆå‘ç”Ÿé‡å¤§å˜å¼‚ã€æ¿’ä¸´ç­ç»æˆ–ç§ç¾¤æ¿€å¢çš„ç‰©ç§ï¼‰è°ƒç”¨æ˜‚è´µçš„ GPT-4 æ¨¡å‹ç”Ÿæˆè¯¦ç»†æˆ˜æŠ¥ã€‚

## 2. æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1 ç‰©ç§ (Species)
ç‰©ç§ä¸ä»…ä»…æ˜¯ä¸€æ®µæ–‡æœ¬ï¼Œå®ƒæ˜¯ä¸€ä¸ªç»“æ„åŒ–çš„å¯¹è±¡ï¼š
*   `morphology_stats`: æ•°å€¼å±æ€§ï¼ˆä½“é•¿ã€ä½“é‡ã€ä»£è°¢ç‡ï¼‰ã€‚
*   `abstract_traits`: é€‚åº”æ€§è¯„åˆ†ï¼ˆè€å¯’: 8.5, è€æ—±: 3.0ï¼‰ã€‚
*   `organs`: **[æ–°å¢]** ç»“æ„åŒ–å™¨å®˜åº“ï¼ˆ`{ "movement": { "type": "wings", "cost": 0.2 } }`ï¼‰ã€‚
*   `capabilities`: **[æ–°å¢]** èƒ½åŠ›æ ‡ç­¾åˆ—è¡¨ï¼ˆå¦‚ `["photosynthesis", "flight"]`ï¼‰ã€‚
*   `trophic_level`: **[æ–°å¢]** è¥å…»çº§æ•°å€¼ï¼ˆ1.0 - 5.0ï¼‰ã€‚
*   `lineage_code`: å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå¦‚ "A1-B2"ï¼‰ï¼Œè•´å«äº†æ¼”åŒ–è·¯å¾„ä¿¡æ¯ã€‚

### 2.2 åœ°å›¾ (MapTile)
*   é‡‡ç”¨ **Axial Coordinates (q, r)** å­˜å‚¨å…­è¾¹å½¢åæ ‡ã€‚
*   æ•°æ®åˆ†ç¦»ï¼š`elevation` (ç»å¯¹æµ·æ‹”) vs `sea_level` (æµ·å¹³é¢)ã€‚
*   åŠ¨æ€è®¡ç®—ï¼šç”Ÿç‰©ç¾¤ç³» (Biome) æ˜¯æ ¹æ®æµ·æ‹”ã€æ¸©åº¦ã€æ¹¿åº¦å®æ—¶æ¨å¯¼çš„ï¼Œè€Œéæ­»æ•°æ®ã€‚

## 3. ç›®å½•ç»“æ„è¯¦è§£

```text
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ ai/                 # LLM é›†æˆ (Model Router, Prompts)
â”‚   â”œâ”€â”€ api/                # FastAPI è·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ core/               # åŸºç¡€è®¾æ–½ (DB, Config)
â”‚   â”œâ”€â”€ models/             # SQLModel æ•°æ®å®šä¹‰
â”‚   â”œâ”€â”€ repositories/       # æ•°æ®è®¿é—®å±‚ (CRUD)
â”‚   â”œâ”€â”€ schemas/            # Pydantic è¯·æ±‚/å“åº”æ¨¡å‹
â”‚   â”œâ”€â”€ services/           # ä¸šåŠ¡é€»è¾‘ (æ ¸å¿ƒç®—æ³•)
â”‚   â”‚   â”œâ”€â”€ map_evolution.py     # å…¨çƒåœ°å›¾å‚æ•°æ¼”åŒ–
â”‚   â”‚   â”œâ”€â”€ tiering.py           # ç‰©ç§åˆ†çº§ç®¡ç†
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ simulation/         # å¼•æ“ä¸»å¾ªç¯
â”œâ”€â”€ tests/                  # å•å…ƒæµ‹è¯•
â””â”€â”€ pyproject.toml          # ä¾èµ–ç®¡ç†
```

## 4. å‰ç«¯æ¶æ„ (Frontend Architecture)

å‰ç«¯æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ React åº”ç”¨ï¼Œè´Ÿè´£å¯è§†åŒ–å¤æ‚çš„æ¼”åŒ–æ•°æ®ã€‚

*   **æŠ€æœ¯æ ˆ**: Vite + React + TypeScript + D3.js + Recharts
*   **æ ¸å¿ƒç»„ä»¶**:
    *   `components/GlobalTrendsPanel.tsx`: å…¨çƒè¶‹åŠ¿ä»ªè¡¨ç›˜ï¼Œå±•ç¤ºç¯å¢ƒä¸ç”Ÿç‰©é‡å†å²æ›²çº¿ã€‚
    *   `components/SpeciesLedger.tsx`: ç‰©ç§æ€»è´¦ï¼Œæä¾›å¯æ’åºã€ç­›é€‰çš„ç‰©ç§åˆ—è¡¨è§†å›¾ã€‚
    *   `components/OrganismBlueprint.tsx`: ç”Ÿç‰©è“å›¾ï¼Œå¯è§†åŒ–å±•ç¤ºç‰©ç§çš„å™¨å®˜ç»“æ„ä¸æ•°å€¼é¢æ¿ã€‚
    *   `components/FoodWebGraph.tsx`: é£Ÿç‰©ç½‘å…³ç³»å›¾ï¼Œå±•ç¤ºæ•é£Ÿä¸è¢«æ•é£Ÿå…³ç³»ã€‚
    *   `components/MapPanel.tsx`: å…­è¾¹å½¢åœ°å›¾æ¸²æŸ“å™¨ï¼Œæ”¯æŒåœ°å½¢/ç”Ÿç‰©é‡/æ¸©åº¦ç­‰å¤šç§è§†å›¾æ¨¡å¼ã€‚
    *   `components/GenealogyGraphView.tsx`: äº¤äº’å¼æ—è°±æ ‘ã€‚
    *   `services/api.ts`: å¼ºç±»å‹çš„ API å®¢æˆ·ç«¯ã€‚

## 5. æ•°æ®åº“ç®¡ç† (Database Management)

ç³»ç»Ÿä½¿ç”¨ **SQLModel (SQLAlchemy + Pydantic)** ä½œä¸º ORMã€‚

*   **è‡ªåŠ¨å»ºè¡¨**: ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶åˆ›å»ºç¼ºå¤±çš„è¡¨ (`backend/app/core/database.py:init_db`)ã€‚
*   **æ— è¿ç§»å·¥å…·**: ç›®å‰æœªé›†æˆ Alembicã€‚
    *   âš ï¸ **æ³¨æ„**: å¦‚æœä½ ä¿®æ”¹äº† `backend/app/models/` ä¸‹çš„æ¨¡å‹å®šä¹‰ï¼Œå¿…é¡»åˆ é™¤ `data/db/egame.db` æ–‡ä»¶ï¼Œé‡å¯åç«¯ä»¥è§¦å‘é‡å»ºã€‚
    *   æˆ–è€…ä½¿ç”¨å‰ç«¯çš„â€œé‡ç½®ä¸–ç•Œâ€åŠŸèƒ½ã€‚

## 6. è¿ç»´ä¸è°ƒè¯•å·¥å…· (Scripts & Ops)

ä¸ºäº†ç®€åŒ–å¼€å‘æµç¨‹ï¼Œæˆ‘ä»¬å°†æ ¸å¿ƒè¿ç»´å·¥å…·é›†æˆåˆ°äº†å‰ç«¯ UI çš„ **"è®¾ç½® -> å¼€å‘è€…å·¥å…·"** ä¸­ã€‚

### 6.1 å¼€å‘è€…å·¥å…·é¢æ¿ (Admin Panel)
å‰ç«¯é¢æ¿ (`frontend/src/components/AdminPanel.tsx`) æä¾›äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

*   **ç³»ç»Ÿå¥åº· (System Health)**: æ£€æŸ¥ APIã€æ•°æ®åº“åŠå…³é”®ç›®å½•çŠ¶æ€ã€‚
*   **é‡ç½®ä¸–ç•Œ (Reset World)**: ä¸€é”®æ¸…ç©ºæ•°æ®ï¼Œæ”¯æŒä¿ç•™å­˜æ¡£æˆ–åœ°å›¾ã€‚
*   **åœ°å½¢æ²™ç›’ (Terrain Sandbox)**: **å·²ä¸‹çº¿**ï¼Œè¯·ä½¿ç”¨æ­£å¼æ¨¡æ‹Ÿå›åˆéªŒè¯ç¯å¢ƒå˜åŒ–ã€‚

### 6.2 å‘½ä»¤è¡Œè„šæœ¬ (Legacy Scripts)
`scripts/` ç›®å½•ä¸‹ä¿ç•™çš„ Python è„šæœ¬ï¼Œä¾› CI/CD ä½¿ç”¨ï¼š
*   `scripts/health_check.py`
*   `scripts/reset_world.py`

## 7. å¼€å‘æŒ‡å—

### 7.1 å¦‚ä½•æ–°å¢ä¸€ç§ç¯å¢ƒå‹åŠ›ï¼Ÿ
1.  åœ¨ `backend/app/schemas/requests.py` çš„ `PressureConfig` ä¸­å®šä¹‰ã€‚
2.  åœ¨ `backend/app/services/environment_system.py` ä¸­æ·»åŠ è§£æé€»è¾‘ã€‚
3.  åœ¨ `backend/app/simulation/species.py` ä¸­æ·»åŠ è¯¥å‹åŠ›å¯¹æ­»äº¡ç‡çš„å½±å“å…¬å¼ã€‚

### 7.2 å¦‚ä½•è°ƒæ•´ AI çš„åˆ›é€ åŠ›ï¼Ÿ
*   ä¿®æ”¹ `backend/app/ai/prompts/` ä¸‹çš„æ¨¡æ¿ã€‚
*   åœ¨ `data/settings.json` ä¸­è°ƒæ•´ `temperature` å‚æ•°ã€‚

### 7.3 AI æ¨¡å‹é…ç½® (Model Router)
ç³»ç»Ÿæ”¯æŒå¤šæ¨¡å‹è·¯ç”±ï¼Œå¯åœ¨ `.env` æˆ–å‰ç«¯è®¾ç½®ä¸­é…ç½®ï¼š
*   **è·¯ç”±é€»è¾‘**: `backend/app/ai/model_router.py` è´Ÿè´£å°†ä¸åŒä»»åŠ¡ï¼ˆå¦‚ `narrative`, `speciation`ï¼‰åˆ†å‘ç»™ä¸åŒçš„æ¨¡å‹é…ç½®ã€‚
*   **UI é…ç½®**: å‰ç«¯è®¾ç½®é¡µé¢å¯ä»¥ç›´æ¥ä¿®æ”¹ä¸åŒèƒ½åŠ›çš„æ¨¡å‹å‚æ•°ã€‚
